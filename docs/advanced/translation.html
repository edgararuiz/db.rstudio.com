<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-(Local Development)">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Databases using R – SQL translation</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="../site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="../site_libs/quarto-nav/headroom.min.js"></script>
  <script src="../site_libs/quarto-html/quarto.js"></script>
  <script src="../site_libs/quarto-html/popper.min.js"></script>
  <script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="../site_libs/quarto-html/clipboard.min.js"></script>
  <script src="../site_libs/quarto-html/anchor.min.js"></script>
  <script src="../site_libs/quarto-html/quarto-html.js"></script>
  <link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="../site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  
  <script type="text/javascript">

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-20375833-3', 'auto');

  ga('send', {
    hitType: 'pageview',
    'anonymizeIp': true,
  });
  </script>
</head>
<body>
<div id="quarto-search-results"></div>
<header id="quarto-header" class="headroom fixed-top">
<nav class="quarto-secondary-nav py-2 d-lg-none d-md-block " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <div class="container-fluid d-flex justify-content-between">
    <h1 class="quarto-secondary-nav-title mb-0 fs-3 d-inline">SQL translation</h1>
    <button type="button" class="quarto-btn-toggle btn d-lg-none py-0 px-1 d-inline-block border-0 ">
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>
</nav>
</header>
 <!-- /navbar/sidebar -->
<div class="container-fluid quarto-container d-flex flex-column page-layout-article">
<div class="row flex-fill" id="quarto-content">
  <div id="quarto-sidebar" class="col col-12 col-lg-3 d-lg-flex px-0 pt-0 sidebar collapse sidebar-navigation">
    <nav class="me-lg-auto py-2 docked  overflow-scroll">
  <div class="px-3 pt-lg-2 mt-1 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">
      Databases using R
      </a> 
    </div>
  </div>
  <div class="sidebar-menu-container"> 
  <ul class="list-unstyled mt-3 px-3">
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#gettingstarted-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Getting Started</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="gettingstarted-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../getting-started/overview.html" class="">Overview</a>
</li>
          <li class="sidebar-item">
  <a href="../getting-started/connect-to-database.html" class="">Connect to a Database</a>
</li>
          <li class="sidebar-item">
  <a href="../getting-started/database-queries.html" class="">Database Queries</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#rpackages-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">R Packages</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="rpackages-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../r-packages/odbc.html" class="">odbc</a>
</li>
          <li class="sidebar-item">
  <a href="../.na.character" class="">DBI</a>
</li>
          <li class="sidebar-item">
  <a href="../r-packages/dplyr.html" class="">dplyr</a>
</li>
          <li class="sidebar-item">
  <a href="../r-packages/pool.html" class="">pool</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#tooling-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Tooling</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="tooling-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../tooling/connections.html" class="">Connections Pane</a>
</li>
          <li class="sidebar-item">
  <a href="../tooling/pro-drivers.html" class="">Professional Drivers</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#bestpractices-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Best Practices</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="bestpractices-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../best-practices/drivers.html" class="">Setting up ODBC Drivers</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/run-queries-safely.html" class="">Run Queries Safely</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/deployment.html" class="">Securing Deployed Content</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/managing-credentials.html" class="">Securing Credentials</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/portable-code.html" class="">Making Scripts Portable</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/visualization.html" class="">Creating Visualizations</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/select-interface.html" class="">Selecting a database interface</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/dashboards.html" class="">Enterprise-ready dashboards</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/schema.html" class="">Schema selection</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#databases-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Databases</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="databases-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../databases/microsoft-sql-server.html" class="">MS SQL Server</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/oracle.html" class="">Oracle</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/teradata.html" class="">Teradata</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/hive.html" class="">Hive</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/impala.html" class="">Impala</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/postgresql.html" class="">PostgreSQL</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/redshift.html" class="">Redshift</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/salesforce.html" class="">Salesforce</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/my-sql.html" class="">MySQL</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/monetdb.html" class="">MonetDB</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/sqlite.html" class="">SQLite</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/big-query.html" class="">Big Query</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/athena.html" class="">Athena</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/mongodb.html" class="">MongoDB</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/netezza.html" class="">Netezza</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/cassandra.html" class="">Cassandra</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/snowflake.html" class="">Snowflake</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/other-databases.html" class="">Other Databases</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#advanced-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Advanced</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="advanced-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../advanced/backend.html" class="">DBI Backend</a>
</li>
          <li class="sidebar-item">
  <a href="../advanced/translation.html" class="active">SQL Translation</a>
</li>
          <li class="sidebar-item">
  <a href="../advanced/contract.html" class="">Connection Contract</a>
</li>
          <li class="sidebar-item">
  <a href="../advanced/snippets.html" class="">Connection Snippet</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#otherresources-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Other Resources</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="otherresources-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../other-resources/media.html" class="">Media</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
  </ul>
  </div>
</nav>
  </div>
  <div class="col mx-auto col-sm-12 col-md-11 col-lg-9 px-lg-4">
<main>
<header id="title-block-header">
<h1 class="title d-none d-lg-block display-7">SQL translation</h1>
</header>
<p>There are two components to <code>dplyr</code>’s SQL translation system:</p>
<ul>
<li><p>translation of vector expressions like <code>x * y + 10</code></p></li>
<li><p>translation of whole verbs like <code>mutate()</code> or <code>summarise()</code></p></li>
</ul>
<p>To explore them, you’ll need to load both <code>dbplyr</code> and <code>dplyr</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dbplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="vectors" class="level2">
<h2 class="anchored" data-anchor-id="vectors">Vectors</h2>
<p>Most filtering, mutating, or summarising operations only perform simple mathematical operations. These operations are very similar between R and SQL, so they’re easy to translate. To see what’s happening yourself, you can use <code>translate_sql()</code>. The basic techniques that underlie the implementation of <code>translate_sql()</code> are described in <a href="http://adv-r.had.co.nz/dsl.html">“Advanced R”</a>. <code>translate_sql()</code> is built on top of R’s parsing engine and has been carefully designed to generate correct SQL. It also protects you against SQL injection attacks by correctly escaping the strings and variable names needed by the database that you’re connecting to.</p>
<p>The following examples work through some of the basic differences between R and SQL.</p>
<ul>
<li><code>"</code> and <code>'</code> mean different things</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
# In SQLite, variable names are escaped by double quotes:
translate_sql(x)
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; `x`
```
:::

```{.r .cell-code}
# And strings are escaped by single quotes
translate_sql("x")
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; 'x'
```
:::</code></pre>
<p>:::</p>
<ul>
<li>Many functions have slightly different names</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
translate_sql(x == 1 &amp;&amp; (y &lt; 2 || z &gt; 3))
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; `x` = 1.0 AND (`y` &lt; 2.0 OR `z` &gt; 3.0)
```
:::

```{.r .cell-code}
translate_sql(x ^ 2 &lt; 10)
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; POWER(`x`, 2.0) &lt; 10.0
```
:::

```{.r .cell-code}
translate_sql(x %% 2 == 10)
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; `x` % 2.0 = 10.0
```
:::</code></pre>
<p>::: * And some functions have different argument orders:</p>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
translate_sql(substr(x, 5, 10))
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; SUBSTR(`x`, 5, 6)
```
:::

```{.r .cell-code}
translate_sql(log(x, 10))
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; LOG(10.0, `x`)
```
:::</code></pre>
<p>:::</p>
<ul>
<li>R and SQL have different defaults for integers and reals. In R, 1 is a real, and 1L is an integer. In SQL, 1 is an integer, and 1.0 is a real</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
translate_sql(1)
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; 1.0
```
:::

```{.r .cell-code}
translate_sql(1L)
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; 1
```
:::</code></pre>
<p>:::</p>
<ul>
<li>If statements are translated into a case statement:</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
translate_sql(if (x &gt; 5) "big" else "small")
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt; CASE WHEN (`x` &gt; 5.0) THEN ('big') WHEN NOT(`x` &gt; 5.0) THEN ('small') END
```
:::</code></pre>
<p>:::</p>
<section id="known-functions" class="level3">
<h3 class="anchored" data-anchor-id="known-functions">Known functions</h3>
<p><code>dplyr</code> knows how to convert the following R functions to SQL:</p>
<ul>
<li>basic math operators: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%%</code>, <code>^</code></li>
<li>math functions: <code>abs</code>, <code>acos</code>, <code>acosh</code>, <code>asin</code>, <code>asinh</code>, <code>atan</code>, <code>atan2</code>, <code>atanh</code>, <code>ceiling</code>, <code>cos</code>, <code>cosh</code>, <code>cot</code>, <code>coth</code>, <code>exp</code>, <code>floor</code>, <code>log</code>, <code>log10</code>, <code>round</code>, <code>sign</code>, <code>sin</code>, <code>sinh</code>, <code>sqrt</code>, <code>tan</code>, <code>tanh</code></li>
<li>logical comparisons: <code>&lt;</code>, <code>&lt;=</code>, <code>!=</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>==</code>, <code>%in%</code></li>
<li>boolean operations: <code>&amp;</code>, <code>&amp;&amp;</code>, <code>|</code>, <code>||</code>, <code>!</code>, <code>xor</code></li>
<li>basic aggregations: <code>mean</code>, <code>sum</code>, <code>min</code>, <code>max</code>, <code>sd</code>, <code>var</code></li>
<li>string functions: <code>tolower</code>, <code>toupper</code>, <code>trimws</code>, <code>nchar</code>, <code>substr</code></li>
<li>coerce types: <code>as.numeric</code>, <code>as.integer</code>, <code>as.character</code></li>
</ul>
<p>Perfect translation is not possible because databases don’t have all the functions that R does. The goal of <code>dplyr</code> is to provide a semantic rather than a literal translation: what you mean rather than what is done. In fact, even for functions that exist both in databases and R, you shouldn’t expect results to be identical; database programmers have different priorities than R core programmers. For example, in R, in order to get a higher level of numerical accuracy, <code>mean()</code> loops through the data twice. R’s <code>mean()</code> also provides a <code>trim</code> option for computing trimmed means; this is something that databases do not provide. Databases automatically drop NULLs (their equivalent of missing values), whereas in R you have to ask nicely. This means the essence of simple calls like <code>mean(x)</code> will be translated accurately, but more complicated calls like <code>mean(x, trim = 0.5, na.rm = TRUE)</code> will raise an error:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; AVG(`x`) OVER ()</code></pre>
</div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">mean</span>(x, <span class="at">trim =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-error">
<pre><code>#&gt; Error in mean(x, trim = 0.1): unused argument (trim = 0.1)</code></pre>
</div>
</div>
<p><code>translate_sql()</code> takes an optional <code>con</code> parameter. If not supplied, this causes <code>dplyr</code> to generate (approximately) SQL-92-compliant SQL. If supplied, <code>dplyr</code> uses <code>sql_translate_env()</code> to look up a custom environment, which makes it possible for different databases to generate slightly different SQL; see <code>vignette("new-backend")</code> for more details.</p>
</section>
<section id="unknown-functions" class="level3">
<h3 class="anchored" data-anchor-id="unknown-functions">Unknown functions</h3>
<p>Any function that <code>dplyr</code> doesn’t know how to convert is left as-is. This means that database functions that are not covered by <code>dplyr</code> can be used directly via <code>translate_sql()</code>. Here a couple of examples that will work with <a href="http://www.sqlite.org/lang_corefunc.html">SQLite</a>:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">glob</span>(x, y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; glob(`x`, `y`)</code></pre>
</div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(x <span class="sc">%like%</span> <span class="st">"ab%"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; `x` like 'ab%'</code></pre>
</div>
</div>
</section>
<section id="window-functions" class="level3">
<h3 class="anchored" data-anchor-id="window-functions">Window functions</h3>
<p>Things get a little trickier with window functions, because SQL’s window functions are considerably more expressive than the specific variants provided by base R or <code>dplyr</code>. They have the form <code>[expression] OVER ([partition clause] [order clause] [frame_clause])</code>:</p>
<ul>
<li><p>The <strong>expression</strong> is a combination of variable names and window functions. Support for window functions varies from database to database, but most support the ranking functions, <code>lead</code>, <code>lag</code>, <code>nth</code>, <code>first</code>, <code>last</code>, <code>count</code>, <code>min</code>, <code>max</code>, <code>sum</code>, <code>avg</code> and <code>stddev</code>.</p></li>
<li><p>The <strong>partition clause</strong> specifies how the window function is broken down over groups. It plays an analogous role to <code>GROUP BY</code> for aggregate functions, and <code>group_by()</code> in <code>dplyr</code>. It is possible for different window functions to be partitioned into different groups, but not all databases support it, and neither does <code>dplyr</code>.</p></li>
<li><p>The <strong>order clause</strong> controls the ordering (when it makes a difference). This is important for the ranking functions since it specifies which variables to rank by, but it’s also needed for cumulative functions and lead. Whenever you’re thinking about before and after in SQL, you must always tell it which variable defines the order. If the order clause is missing when needed, some databases fail with an error message while others return non-deterministic results.</p></li>
<li><p>The <strong>frame clause</strong> defines which rows, or <strong>frame</strong>, that are passed to the window function, describing which rows (relative to the current row) should be included. The frame clause provides two offsets which determine the start and end of frame. There are three special values: <code>-Inf</code> means to include all preceeding rows (in SQL, “unbounded preceding”), <code>0</code> means the current row (“current row”), and <code>Inf</code> means all following rows (“unbounded following)”. The complete set of options is comprehensive, but fairly confusing, and is summarised visually below.</p>
<p>Of the many possible specifications, there are only three that commonly used. They select between aggregation variants:</p>
<ul>
<li><p>Recycled: <code>BETWEEN UNBOUND PRECEEDING AND UNBOUND FOLLOWING</code></p></li>
<li><p>Cumulative: <code>BETWEEN UNBOUND PRECEEDING AND CURRENT ROW</code></p></li>
<li><p>Rolling: <code>BETWEEN 2 PRECEEDING AND 2 FOLLOWING</code></p></li>
</ul>
<p><code>dplyr</code> generates the frame clause based on whether your using a recycled aggregate or a cumulative aggregate.</p></li>
</ul>
<p>To see how individual window functions are translated to SQL, we can again use <code>translate_sql()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">mean</span>(G))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stderr">
<pre><code>#&gt; Warning: Missing values are always removed in SQL.
#&gt; Use `AVG(x, na.rm = TRUE)` to silence this warning
#&gt; This warning is displayed only once per session.</code></pre>
</div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; AVG(`G`) OVER ()</code></pre>
</div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">rank</span>(G))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; RANK() OVER (ORDER BY `G`)</code></pre>
</div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">ntile</span>(G, <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; NTILE(2) OVER (ORDER BY `G`)</code></pre>
</div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">lag</span>(G))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; LAG(`G`, 1, NULL) OVER ()</code></pre>
</div>
</div>
<p>If the tbl has been grouped or arranged previously in the pipeline, then <code>dplyr</code> will use that information to set the “partition by” and “order by” clauses. For interactive exploration, you can achieve the same effect by setting the <code>vars_group</code> and <code>vars_order</code> arguments to <code>translate_sql()</code></p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">cummean</span>(G), <span class="at">vars_order =</span> <span class="st">"year"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; AVG(`G`) OVER (ORDER BY `year` ROWS UNBOUNDED PRECEDING)</code></pre>
</div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">translate_sql</span>(<span class="fu">rank</span>(), <span class="at">vars_group =</span> <span class="st">"ID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt; RANK() OVER (PARTITION BY `ID`)</code></pre>
</div>
</div>
<p>There are some challenges when translating window functions between R and SQL, because <code>dplyr</code> tries to keep the window functions as similar as possible to both the existing R analogues and to the SQL functions. This means that there are three ways to control the order clause depending on which window function you’re using:</p>
<ul>
<li><p>For ranking functions, the ordering variable is the first argument: <code>rank(x)</code>, <code>ntile(y, 2)</code>. If omitted or <code>NULL</code>, will use the default ordering associated with the tbl (as set by <code>arrange()</code>).</p></li>
<li><p>Accumulating aggregates only take a single argument (the vector to aggregate). To control ordering, use <code>order_by()</code>.</p></li>
<li><p>Aggregates implemented in <code>dplyr</code> (<code>lead</code>, <code>lag</code>, <code>nth_value</code>, <code>first_value</code>, <code>last_value</code>) have an <code>order_by</code> argument. Supply it to override the default ordering.</p></li>
</ul>
<p>The three options are illustrated in the snippet below:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(players,</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">min_rank</span>(yearID),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">order_by</span>(yearID, <span class="fu">cumsum</span>(G)),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lead</span>(G, <span class="at">order_by =</span> yearID)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Currently there is no way to order by multiple variables, except by setting the default ordering with <code>arrange()</code>. This will be added in a future release.</p>
</section>
</section>
<section id="whole-tables" class="level2">
<h2 class="anchored" data-anchor-id="whole-tables">Whole tables</h2>
<p>All <code>dplyr</code> verbs generate a <code>SELECT</code> statement. To demonstrate, we’ll make a temporary database with a couple of tables:</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="st">":memory:"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">copy_to</span>(con, nycflights13<span class="sc">::</span>flights)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>airports <span class="ot">&lt;-</span> <span class="fu">copy_to</span>(con, nycflights13<span class="sc">::</span>airports)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="single-table-verbs" class="level3">
<h3 class="anchored" data-anchor-id="single-table-verbs">Single table verbs</h3>
<ul>
<li><code>select()</code> and <code>mutate()</code> modify the <code>SELECT</code> clause:</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
flights %&gt;%
  select(contains("delay")) %&gt;%
  show_query()
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt;
#&gt; SELECT `dep_delay`, `arr_delay`
#&gt; FROM `nycflights13::flights`
```
:::

```{.r .cell-code}

flights %&gt;%
  select(distance, air_time) %&gt;%  
  mutate(speed = distance / (air_time / 60)) %&gt;%
  show_query()
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt;
#&gt; SELECT `distance`, `air_time`, `distance` / (`air_time` / 60.0) AS `speed`
#&gt; FROM `nycflights13::flights`
```
:::</code></pre>
<p>:::</p>
<pre><code>(As you can see here, the generated SQL isn't always as minimal as you
might generate by hand.)</code></pre>
<ul>
<li><code>filter()</code> generates a <code>WHERE</code> clause:</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
flights %&gt;% 
  filter(month == 1, day == 1) %&gt;%
  show_query()
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt;
#&gt; SELECT *
#&gt; FROM `nycflights13::flights`
#&gt; WHERE ((`month` = 1.0) AND (`day` = 1.0))
```
:::</code></pre>
<p>:::</p>
<ul>
<li><code>arrange()</code> generates an <code>ORDER BY</code> clause:</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
flights %&gt;% 
  arrange(carrier, desc(arr_delay)) %&gt;%
  show_query()
```

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt;
#&gt; SELECT *
#&gt; FROM `nycflights13::flights`
#&gt; ORDER BY `carrier`, `arr_delay` DESC
```
:::</code></pre>
<p>:::</p>
<ul>
<li><code>summarise()</code> and <code>group_by()</code> work together to generate a <code>GROUP BY</code> clause:</li>
</ul>
<p>::: {.cell indent=” “}</p>
<pre><code>```{.r .cell-code}
flights %&gt;%
  group_by(month, day) %&gt;%
  summarise(delay = mean(dep_delay)) %&gt;%
  show_query()
```

::: {.cell-output-stderr}
```
#&gt; Warning: Missing values are always removed in SQL.
#&gt; Use `mean(x, na.rm = TRUE)` to silence this warning
#&gt; This warning is displayed only once per session.
```
:::

::: {.cell-output-stderr}
```
#&gt; `summarise()` has grouped output by 'month'. You can override using the `.groups` argument.
```
:::

::: {.cell-output-stdout}
```
#&gt; &lt;SQL&gt;
#&gt; SELECT `month`, `day`, AVG(`dep_delay`) AS `delay`
#&gt; FROM `nycflights13::flights`
#&gt; GROUP BY `month`, `day`
```
:::</code></pre>
<p>:::</p>
</section>
<section id="dual-table-verbs" class="level3">
<h3 class="anchored" data-anchor-id="dual-table-verbs">Dual table verbs</h3>
<div class="line-block"><code>inner_join()</code> | <code>SELECT * FROM x JOIN y ON x.a = y.a</code><br>
<code>left_join()</code> | <code>SELECT * FROM x LEFT JOIN y ON x.a = y.a</code><br>
<code>right_join()</code> | <code>SELECT * FROM x RIGHT JOIN y ON x.a = y.a</code><br>
<code>full_join()</code> | <code>SELECT * FROM x FULL JOIN y ON x.a = y.a</code><br>
<code>semi_join()</code> | <code>SELECT * FROM x WHERE EXISTS (SELECT 1 FROM y WHERE x.a = y.a)</code><br>
<code>anti_join()</code> | <code>SELECT * FROM x WHERE NOT EXISTS (SELECT 1 FROM y WHERE x.a = y.a)</code><br>
<code>intersect(x, y)</code>| <code>SELECT * FROM x INTERSECT SELECT * FROM y</code><br>
<code>union(x, y)</code> | <code>SELECT * FROM x UNION SELECT * FROM y</code><br>
<code>setdiff(x, y)</code> | <code>SELECT * FROM x EXCEPT SELECT * FROM y</code></div>
<p><code>x</code> and <code>y</code> don’t have to be tables in the same database. If you specify <code>copy = TRUE</code>, <code>dplyr</code> will copy the <code>y</code> table into the same location as the <code>x</code> variable. This is useful if you’ve downloaded a summarised dataset and determined a subset of interest that you now want the full data for. You can use <code>semi_join(x, y, copy = TRUE)</code> to upload the indices of interest to a temporary table in the same database as <code>x</code>, and then perform a efficient semi join in the database.</p>
<p>If you’re working with large data, it maybe also be helpful to set <code>auto_index = TRUE</code>. That will automatically add an index on the join variables to the temporary table.</p>
</section>
<section id="behind-the-scenes" class="level3">
<h3 class="anchored" data-anchor-id="behind-the-scenes">Behind the scenes</h3>
<p>The verb level SQL translation is implemented on top of <code>tbl_lazy</code>, which basically tracks the operations you perform in a pipeline (see <code>lazy-ops.R</code>). Turning that into a SQL query takes place in three steps:</p>
<ul>
<li><p><code>sql_build()</code> recurses over the lazy op data structure building up query objects (<code>select_query()</code>, <code>join_query()</code>, <code>set_op_query()</code>, etc.) that represent the different subtypes of <code>SELECT</code> queries that we might generate.</p></li>
<li><p><code>sql_optimise()</code> takes a pass over these SQL objects, looking for potential optimisations. Currently this only involves removing subqueries where possible.</p></li>
<li><p><code>sql_render()</code> calls an SQL generation function (<code>sql_select()</code>, <code>sql_join()</code>, <code>sql_subquery()</code>, <code>sql_semijoin()</code>, etc.) to produce the actual SQL. Each of these functions is a generic, taking the connection as an argument, so that the details can be customised for different databases.</p></li>
</ul>
<!-- -->
</section>
</section>
</main>
<div class="page-navigation page-navigation-docked">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
  </div>
</div>
</div> <!-- /main column -->
</div> <!-- /row -->
</div> <!-- /container fluid -->


</body></html>