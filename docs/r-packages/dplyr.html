<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang=""><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-(Local Development)">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Databases using R â€“ Using dplyr with databases</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="../site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="../site_libs/quarto-nav/headroom.min.js"></script>
  <script src="../site_libs/quarto-html/quarto.js"></script>
  <script src="../site_libs/quarto-html/popper.min.js"></script>
  <script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="../site_libs/quarto-html/clipboard.min.js"></script>
  <script src="../site_libs/quarto-html/anchor.min.js"></script>
  <script src="../site_libs/quarto-html/quarto-html.js"></script>
  <link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="../site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  
  <script type="text/javascript">

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-20375833-3', 'auto');

  ga('send', {
    hitType: 'pageview',
    'anonymizeIp': true,
  });
  </script>
</head>
<body>
<div id="quarto-search-results"></div>
<header id="quarto-header" class="headroom fixed-top">
<nav class="quarto-secondary-nav py-2 d-lg-none d-md-block " data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <div class="container-fluid d-flex justify-content-between">
    <h1 class="quarto-secondary-nav-title mb-0 fs-3 d-inline">Using dplyr with databases</h1>
    <button type="button" class="quarto-btn-toggle btn d-lg-none py-0 px-1 d-inline-block border-0 ">
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>
</nav>
</header>
 <!-- /navbar/sidebar -->
<div class="container-fluid quarto-container d-flex flex-column page-layout-article">
<div class="row flex-fill" id="quarto-content">
  <div id="quarto-sidebar" class="col col-12 col-lg-3 d-lg-flex px-0 pt-0 sidebar collapse sidebar-navigation">
    <nav class="me-lg-auto py-2 docked  overflow-scroll">
  <div class="px-3 pt-lg-2 mt-1 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">
      Databases using R
      </a> 
    </div>
  </div>
  <div class="sidebar-menu-container"> 
  <ul class="list-unstyled mt-3 px-3">
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#gettingstarted-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Getting Started</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="gettingstarted-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../getting-started/overview.html" class="">Overview</a>
</li>
          <li class="sidebar-item">
  <a href="../getting-started/connect-to-database.html" class="">Connect to a Database</a>
</li>
          <li class="sidebar-item">
  <a href="../getting-started/database-queries.html" class="">Database Queries</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#rpackages-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">R Packages</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="rpackages-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../r-packages/odbc.html" class="">odbc</a>
</li>
          <li class="sidebar-item">
  <a href="../r-packages/DBI.html" class="">DBI</a>
</li>
          <li class="sidebar-item">
  <a href="../r-packages/dplyr.html" class="active">dplyr</a>
</li>
          <li class="sidebar-item">
  <a href="../r-packages/pool.html" class="">pool</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#tooling-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Tooling</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="tooling-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../tooling/connections.html" class="">Connections Pane</a>
</li>
          <li class="sidebar-item">
  <a href="../tooling/pro-drivers.html" class="">Professional Drivers</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#bestpractices-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Best Practices</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="bestpractices-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../best-practices/drivers.html" class="">Setting up ODBC Drivers</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/run-queries-safely.html" class="">Run Queries Safely</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/deployment.html" class="">Securing Deployed Content</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/managing-credentials.html" class="">Securing Credentials</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/portable-code.html" class="">Making Scripts Portable</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/visualization.html" class="">Creating Visualizations</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/select-interface.html" class="">Selecting a database interface</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/dashboards.html" class="">Enterprise-ready dashboards</a>
</li>
          <li class="sidebar-item">
  <a href="../best-practices/schema.html" class="">Schema selection</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#databases-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Databases</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="databases-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../databases/microsoft-sql-server.html" class="">MS SQL Server</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/oracle.html" class="">Oracle</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/teradata.html" class="">Teradata</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/hive.html" class="">Hive</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/impala.html" class="">Impala</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/postgresql.html" class="">PostgreSQL</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/redshift.html" class="">Redshift</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/salesforce.html" class="">Salesforce</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/my-sql.html" class="">MySQL</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/monetdb.html" class="">MonetDB</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/sqlite.html" class="">SQLite</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/big-query.html" class="">Big Query</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/athena.html" class="">Athena</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/mongodb.html" class="">MongoDB</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/netezza.html" class="">Netezza</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/cassandra.html" class="">Cassandra</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/snowflake.html" class="">Snowflake</a>
</li>
          <li class="sidebar-item">
  <a href="../databases/other-databases.html" class="">Other Databases</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#advanced-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Advanced</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="advanced-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../advanced/backend.html" class="">DBI Backend</a>
</li>
          <li class="sidebar-item">
  <a href="../advanced/translation.html" class="">SQL Translation</a>
</li>
          <li class="sidebar-item">
  <a href="../advanced/contract.html" class="">Connection Contract</a>
</li>
          <li class="sidebar-item">
  <a href="../advanced/snippets.html" class="">Connection Snippet</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
      <ul class="list-unstyled sidebar-section depth1">
    <li class="">
        <div class="me-auto ">
            <a class="sidebar-section-item d-inline-flex text-start w-100 " data-bs-toggle="collapse" data-bs-target="#otherresources-collapse" aria-expanded="true">
              <div class="me-auto  sidebar-section-item">Other Resources</div>
            <div><i class="bi bi-chevron-right ms-2 "></i></div>
            </a>
        </div>
      <div class="collapse  show" id="otherresources-collapse">
        <ul class="list-unstyled sidebar-item-contents">
          <li class="sidebar-item">
  <a href="../other-resources/media.html" class="">Media</a>
</li>
        </ul>
      </div>
    </li>
  </ul>
  </ul>
  </div>
</nav>
  </div>
  <div class="col mx-auto col-sm-12 col-md-11 col-lg-9 px-lg-4">
<main>
<header id="title-block-header">
<h1 class="title d-none d-lg-block display-7">Using dplyr with databases</h1>
</header>
<p>As well as working with local in-memory data stored in data frames, <code>dplyr</code> also works with remote on-disk data stored in databases. This is particularly useful in two scenarios:</p>
<ul>
<li><p>Your data is already in a database.</p></li>
<li><p>You have so much data that it does not all fit into memory simultaneously and you need to use some external storage engine.</p></li>
</ul>
<p>(If your data fits in memory, there is no advantage to putting it in a database; it will only be slower and more frustrating.)</p>
<p>This vignette focuses on the first scenario because it is the most common. If you are using R to do data analysis inside a company, most of the data you need probably already lives in a database (itâ€™s just a matter of figuring out which one!). However, you will learn how to load data in to a local database in order to demonstrate <code>dplyr</code>â€™s database tools. At the end, Iâ€™ll also give you a few pointers if you do need to set up your own database.</p>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting started</h2>
<p>To use databases with <code>dplyr</code>, you need to first install <code>dbplyr</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"dbplyr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Youâ€™ll also need to install a DBI backend package. The <code>DBI</code> package provides a common interface that allows <code>dplyr</code> to work with many different databases using the same code. <code>DBI</code> is automatically installed with <code>dbplyr</code>, but you need to install a specific backend for the database that you want to connect to.</p>
<p>Five commonly used backends are:</p>
<ul>
<li><p><a href="https://github.com/rstats-db/RMySQL#readme">RMySQL</a> connects to MySQL and MariaDB</p></li>
<li><p><a href="https://CRAN.R-project.org/package=RPostgreSQL">RPostgreSQL</a> connects to Postgres and Redshift.</p></li>
<li><p><a href="https://github.com/rstats-db/RSQLite">RSQLite</a> embeds a SQLite database.</p></li>
<li><p><a href="https://github.com/rstats-db/odbc#odbc">odbc</a> connects to many commercial databases via the open database connectivity protocol.</p></li>
<li><p><a href="https://github.com/rstats-db/bigrquery">bigrquery</a> connects to Googleâ€™s BigQuery.</p></li>
</ul>
<p>If the database you need to connect to is not listed here, youâ€™ll need to do some investigation yourself.</p>
<p>In this vignette, weâ€™re going to use the <code>RSQLite</code> backend, which is automatically installed when you install <code>dbplyr</code>. SQLite is a great way to get started with databases because itâ€™s completely embedded inside an R package. Unlike most other systems, you donâ€™t need to set up a separate database server. SQLite is great for demos, but is surprisingly powerful, and with a little practice you can use it to easily work with many gigabytes of data.</p>
</section>
<section id="connecting-to-the-database" class="level2">
<h2 class="anchored" data-anchor-id="connecting-to-the-database">Connecting to the database</h2>
<p>To work with a database in <code>dplyr</code>, you must first connect to it, using <code>DBI::dbConnect()</code>. Weâ€™re not going to go into the details of the <code>DBI</code> package here, but itâ€™s the foundation upon which <code>dbplyr</code> is built. Youâ€™ll need to learn more about if you need to do things to the database that are beyond the scope of <code>dplyr</code>.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RSQLite<span class="sc">::</span><span class="fu">SQLite</span>(), <span class="at">path =</span> <span class="st">":dbname:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The arguments to <code>DBI::dbConnect()</code> vary from database to database, but the first argument is always the database backend. Itâ€™s <code>RSQLite::SQLite()</code> for RSQLite, <code>RMySQL::MySQL()</code> for RMySQL, <code>RPostgreSQL::PostgreSQL()</code> for RPostgreSQL, <code>odbc::odbc()</code> for odbc, and <code>bigrquery::bigquery()</code> for BigQuery. SQLite only needs one other argument: the path to the database. Here we use the special string, <code>":memory:"</code>, which causes SQLite to make a temporary in-memory database.</p>
<p>Most existing databases donâ€™t live in a file, but instead live on another server. In real life that your code will look more like this:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(RMySQL<span class="sc">::</span><span class="fu">MySQL</span>(), </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">host =</span> <span class="st">"database.rstudio.com"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">user =</span> <span class="st">"hadley"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> rstudioapi<span class="sc">::</span><span class="fu">askForPassword</span>(<span class="st">"Database password"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(If youâ€™re not using RStudio, youâ€™ll need some other way to securely retrieve your password. You should never record it in your analysis scripts or type it into the console.)</p>
<p>Our temporary database has no data in it, so weâ€™ll start by copying over <code>nycflights13::flights</code> using the convenient <code>copy_to()</code> function. This is a quick and dirty way of getting data into a database and is useful primarily for demos and other small jobs.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">copy_to</span>(con, nycflights13<span class="sc">::</span>flights, <span class="st">"flights"</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">temporary =</span> <span class="cn">FALSE</span>, </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">indexes =</span> <span class="fu">list</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>), </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"carrier"</span>, </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tailnum"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dest"</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As you can see, the <code>copy_to()</code> operation has an additional argument that allows you to supply indexes for the table. Here we set up indexes that will allow us to quickly process the data by day, carrier, plane, and destination. Creating the write indices is key to good database performance, but is unfortunately beyond the scope of this article.</p>
<p>Now that weâ€™ve copied the data, we can use <code>tbl()</code> to take a reference to it:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>flights_db <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"flights"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When you print it out, youâ€™ll notice that it mostly looks like a regular tibble:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>flights_db </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; # Source:   table&lt;flights&gt; [?? x 19]
#&gt; # Database: sqlite 3.35.5 []
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
#&gt; 1  2013     1     1      517            515         2      830            819
#&gt; 2  2013     1     1      533            529         4      850            830
#&gt; 3  2013     1     1      542            540         2      923            850
#&gt; 4  2013     1     1      544            545        -1     1004           1022
#&gt; 5  2013     1     1      554            600        -6      812            837
#&gt; 6  2013     1     1      554            558        -4      740            728
#&gt; # â€¦ with more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,
#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,
#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The main difference is that you can see that itâ€™s a remote source in a SQLite database.</p>
</section>
<section id="generating-queries" class="level2">
<h2 class="anchored" data-anchor-id="generating-queries">Generating queries</h2>
<p>To interact with a database you usually use SQL, the Structured Query Language. SQL is over 40 years old, and is used by pretty much every database in existence. The goal of <code>dbplyr</code> is to automatically generate SQL for you so that youâ€™re not forced to use it. However, SQL is a very large language, and <code>dbplyr</code> doesnâ€™t do everything. It focuses on <code>SELECT</code> statements, the SQL you write most often as an analyst.</p>
<p>Most of the time you donâ€™t need to know anything about SQL, and you can continue to use the <code>dplyr</code> verbs that youâ€™re already familiar with:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>flights_db <span class="sc">%&gt;%</span> <span class="fu">select</span>(year<span class="sc">:</span>day, dep_delay, arr_delay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; # Source:   lazy query [?? x 5]
#&gt; # Database: sqlite 3.35.5 []
#&gt;    year month   day dep_delay arr_delay
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;
#&gt; 1  2013     1     1         2        11
#&gt; 2  2013     1     1         4        20
#&gt; 3  2013     1     1         2        33
#&gt; 4  2013     1     1        -1       -18
#&gt; 5  2013     1     1        -6       -25
#&gt; 6  2013     1     1        -4        12
#&gt; # â€¦ with more rows</code></pre>
</div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>flights_db <span class="sc">%&gt;%</span> <span class="fu">filter</span>(dep_delay <span class="sc">&gt;</span> <span class="dv">240</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; # Source:   lazy query [?? x 19]
#&gt; # Database: sqlite 3.35.5 []
#&gt;    year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
#&gt; 1  2013     1     1      848           1835       853     1001           1950
#&gt; 2  2013     1     1     1815           1325       290     2120           1542
#&gt; 3  2013     1     1     1842           1422       260     1958           1535
#&gt; 4  2013     1     1     2115           1700       255     2330           1920
#&gt; 5  2013     1     1     2205           1720       285       46           2040
#&gt; 6  2013     1     1     2343           1724       379      314           1938
#&gt; # â€¦ with more rows, and 11 more variables: arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;,
#&gt; #   flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;,
#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dbl&gt;</code></pre>
</div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>flights_db <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(dest) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">delay =</span> <span class="fu">mean</span>(dep_time))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stderr">
<pre><code>#&gt; Warning: Missing values are always removed in SQL.
#&gt; Use `mean(x, na.rm = TRUE)` to silence this warning
#&gt; This warning is displayed only once per session.</code></pre>
</div>
<div class="cell-output-stdout">
<pre><code>#&gt; # Source:   lazy query [?? x 2]
#&gt; # Database: sqlite 3.35.5 []
#&gt;   dest  delay
#&gt;   &lt;chr&gt; &lt;dbl&gt;
#&gt; 1 ABQ   2006.
#&gt; 2 ACK   1033.
#&gt; 3 ALB   1627.
#&gt; 4 ANC   1635.
#&gt; 5 ATL   1293.
#&gt; 6 AUS   1521.
#&gt; # â€¦ with more rows</code></pre>
</div>
</div>
<p>However, in the long run, I highly recommend you at least learn the basics of SQL. Itâ€™s a valuable skill for any data scientist, and it will help you debug problems if you run into problems with <code>dplyr</code>â€™s automatic translation. If youâ€™re completely new to SQL, you might start with this <a href="https://www.codecademy.com/learn/learn-sql">codeacademy tutorial</a>. If you have some familiarity with SQL and youâ€™d like to learn more, I found <a href="http://www.sqlite.org/queryplanner.html">how indexes work in SQLite</a> and <a href="http://blog.jooq.org/2016/03/17/10-easy-steps-to-a-complete-understanding-of-sql">10 easy steps to a complete understanding of SQL</a> to be particularly helpful.</p>
<p>The most important difference between ordinary data frames and remote database queries is that your R code is translated into SQL and executed in the database, not in R. When working with databases, <code>dplyr</code> tries to be as lazy as possible:</p>
<ul>
<li><p>It never pulls data into R unless you explicitly ask for it.</p></li>
<li><p>It delays doing any work until the last possible moment: it collects together everything you want to do and then sends it to the database in one step.</p></li>
</ul>
<p>For example, take the following code:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>tailnum_delay_db <span class="ot">&lt;-</span> flights_db <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(tailnum) <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">delay =</span> <span class="fu">mean</span>(arr_delay),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(delay)) <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Surprisingly, this sequence of operations never touches the database. Itâ€™s not until you ask for the data (e.g., by printing <code>tailnum_delay</code>) that <code>dplyr</code> generates the SQL and requests the results from the database. Even then it tries to do as little work as possible and only pulls down a few rows.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>tailnum_delay_db</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stderr">
<pre><code>#&gt; Warning: ORDER BY is ignored in subqueries without LIMIT
#&gt; â„¹ Do you need to move arrange() later in the pipeline or use window_order() instead?</code></pre>
</div>
<div class="cell-output-stdout">
<pre><code>#&gt; # Source:     lazy query [?? x 3]
#&gt; # Database:   sqlite 3.35.5 []
#&gt; # Ordered by: desc(delay)
#&gt;   tailnum delay     n
#&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;
#&gt; 1 &lt;NA&gt;    NA     2512
#&gt; 2 N0EGMQ   9.98   371
#&gt; 3 N10156  12.7    153
#&gt; 4 N10575  20.7    289
#&gt; 5 N11106  14.9    129
#&gt; 6 N11107  15.0    148
#&gt; # â€¦ with more rows</code></pre>
</div>
</div>
<p>Behind the scenes, <code>dplyr</code> is translating your R code into SQL. You can see the SQL itâ€™s generating with <code>show_query()</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>tailnum_delay_db <span class="sc">%&gt;%</span> <span class="fu">show_query</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stderr">
<pre><code>#&gt; Warning: ORDER BY is ignored in subqueries without LIMIT
#&gt; â„¹ Do you need to move arrange() later in the pipeline or use window_order() instead?</code></pre>
</div>
<div class="cell-output-stdout">
<pre><code>#&gt; &lt;SQL&gt;
#&gt; SELECT *
#&gt; FROM (SELECT `tailnum`, AVG(`arr_delay`) AS `delay`, COUNT(*) AS `n`
#&gt; FROM `flights`
#&gt; GROUP BY `tailnum`)
#&gt; WHERE (`n` &gt; 100.0)</code></pre>
</div>
</div>
<p>If youâ€™re familiar with SQL, this probably isnâ€™t exactly what youâ€™d write by hand, but it does the job. You can learn more about the SQL translation in <code>vignette("sql-translation")</code>.</p>
<p>Typically, youâ€™ll iterate a few times before you figure out what data you need from the database. Once youâ€™ve figured it out, use <code>collect()</code> to pull all the data down into a local tibble:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tailnum_delay <span class="ot">&lt;-</span> tailnum_delay_db <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stderr">
<pre><code>#&gt; Warning: ORDER BY is ignored in subqueries without LIMIT
#&gt; â„¹ Do you need to move arrange() later in the pipeline or use window_order() instead?</code></pre>
</div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tailnum_delay</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; # A tibble: 1,201 x 3
#&gt;   tailnum delay     n
#&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;int&gt;
#&gt; 1 &lt;NA&gt;    NA     2512
#&gt; 2 N0EGMQ   9.98   371
#&gt; 3 N10156  12.7    153
#&gt; 4 N10575  20.7    289
#&gt; 5 N11106  14.9    129
#&gt; 6 N11107  15.0    148
#&gt; # â€¦ with 1,195 more rows</code></pre>
</div>
</div>
<p><code>collect()</code> requires that database does some work, so it may take a long time to complete. Otherwise, <code>dplyr</code> tries to prevent you from accidentally performing expensive query operations:</p>
<ul>
<li><p>Because thereâ€™s generally no way to determine how many rows a query will return unless you actually run it, <code>nrow()</code> is always <code>NA</code>.</p></li>
<li><p>Because you canâ€™t find the last few rows without executing the whole query, you canâ€™t use <code>tail()</code>.</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(tailnum_delay_db)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-stdout">
<pre><code>#&gt; [1] NA</code></pre>
</div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(tailnum_delay_db)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-error">
<pre><code>#&gt; Error: tail() is not supported by sql sources</code></pre>
</div>
</div>
<p>You can also ask the database how it plans to execute the query with <code>explain()</code>. The output is database-dependent and can be esoteric, but learning a bit about it can be very useful because it helps you understand if the database can execute the query efficiently, or if you need to create new indices.</p>
</section>
<section id="creating-your-own-database" class="level2">
<h2 class="anchored" data-anchor-id="creating-your-own-database">Creating your own database</h2>
<p>If you donâ€™t already have a database, hereâ€™s some advice from my experiences setting up and running all of them. SQLite is by far the easiest to get started with, but the lack of window functions makes it limited for data analysis. PostgreSQL is not too much harder to use and has a wide range of built-in functions. In my opinion, you shouldnâ€™t bother with MySQL/MariaDB; itâ€™s a pain to set up, the documentation is sub par, and itâ€™s less feature-rich than Postgres. Google BigQuery might be a good fit if you have very large data, or if youâ€™re willing to pay (a small amount of) money to someone whoâ€™ll look after your database.</p>
<p>All of these databases follow a client-server model - a computer that connects to the database and the computer that is running the database (the two may be one and the same, but usually arenâ€™t). Getting one of these databases up and running is beyond the scope of this article, but there are plenty of tutorials available on the web.</p>
<section id="mysqlmariadb" class="level3">
<h3 class="anchored" data-anchor-id="mysqlmariadb">MySQL/MariaDB</h3>
<p>In terms of functionality, MySQL lies somewhere between SQLite and PostgreSQL. It provides a wider range of <a href="http://dev.mysql.com/doc/refman/5.0/en/functions.html">built-in functions</a>, but it does not support window functions (so you canâ€™t do grouped mutates and filters).</p>
</section>
<section id="postgresql" class="level3">
<h3 class="anchored" data-anchor-id="postgresql">PostgreSQL</h3>
<p>PostgreSQL is a considerably more powerful database than SQLite. It has:</p>
<ul>
<li><p>a much wider range of <a href="http://www.postgresql.org/docs/9.3/static/functions.html">built-in functions</a>, and</p></li>
<li><p>support for <a href="http://www.postgresql.org/docs/9.3/static/tutorial-window.html">window functions</a>, which allow grouped subset and mutates to work.</p></li>
</ul>
</section>
<section id="bigquery" class="level3">
<h3 class="anchored" data-anchor-id="bigquery">BigQuery</h3>
<p>BigQuery is a hosted database server provided by Google. To connect, you need to provide your <code>project</code>, <code>dataset</code> and optionally a project for <code>billing</code> (if billing for <code>project</code> isnâ€™t enabled).</p>
<p>It provides a similar set of functions to Postgres and is designed specifically for analytic workflows. Because itâ€™s a hosted solution, thereâ€™s no setup involved, but if you have a lot of data, getting it to Google can be an ordeal (especially because upload support from R is not great currently). (If you have lots of data, you can <a href="https://cloud.google.com/storage/docs/offline-media-import-export">ship hard drives</a>!)</p>
<!-- -->
</section>
</section>
</main>
<div class="page-navigation page-navigation-docked">
  <div class="nav-page nav-page-previous">
  </div>
  <div class="nav-page nav-page-next">
  </div>
</div>
</div> <!-- /main column -->
</div> <!-- /row -->
</div> <!-- /container fluid -->


</body></html>